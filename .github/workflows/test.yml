name: test

on:
  pull_request:
    types: [opened, edited, reopened]

jobs:
  add-label:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Run script to update labels
        uses: actions/github-script@v7
        with:
          script: |
            async function updateLabels() {
              try {
                const { data: pulls } = await github.rest.pulls({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open'
                });
                
                console.log('pulls',pulls)
            
                const { data: prs } = await github.pulls.list({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open'
                });
            
                console.log('피알들',prs)
            
                for (const pr of prs) {
                  const { data: labels } = await github.issues.listLabelsOnIssue({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: pr.number
                  });
            
                  console.log('라벨들',labels)
            
                  for (const label of labels) {
                    if (label.name.startsWith('D-')) {
            
                      console.log("startWith('D-')")
            
                      const currentLabel = parseInt(label.name.slice(2));
            
                      console.log('현재라벨',currentLabel)
                      console.log('비교',currentLabel > 0)
            
                      if (currentLabel > 0) {
                        const newLabelName = `D-${currentLabel - 1}`;
                        await github.issues.addLabels({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: pr.number,
                          labels: [newLabelName]
                        });
                        await github.issues.removeLabel({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: pr.number,
                          name: label.name
                        });
                      }
                      break;
                    }
                  }
                }
              } catch (error) {
                console.error('Error updating labels:', error);
              }
            }

            setTimeout(updateLabels,1000);
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}
